<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leitura de Códigos de Barras</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    video { width: 100%; max-width: 500px; border: 2px solid #333; }
    canvas { display: none; }
    #result { margin-top: 20px; font-size: 16px; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    input { padding: 10px; font-size: 16px; width: 150px; }
    #scanArea { position: relative; display: inline-block; }
    #focusRect {
      position: absolute;
      border: 3px solid #d00;
      background: rgba(255,0,0,0.08);
      width: 80%;
      height: 150px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      box-shadow: 0 0 10px 2px #d00;
      z-index: 2;
    }
  </style>
</head>
<body>
  <h2>Escaneie os Códigos</h2>
  <div id="scanArea">
    <video id="video" autoplay></video>
    <div id="focusRect"></div>
    <div style="color:#d00; font-weight:bold; margin-top:5px;">Alinhe o código de barras dentro do retângulo vermelho para melhor leitura.</div>
    <button id="flashBtn" style="display:none; margin-top:10px;">Ligar Flash</button>
    <select id="cameraSelect" style="display:none; margin-top:10px;"></select>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>
  <div style="margin-bottom:10px;">
    <button onclick="startScan('nota')">Escanear Nota Fiscal</button>
    <button onclick="showManualInput('nota')">Digitar Nota Fiscal</button>
    <input type="text" id="manualNota" placeholder="Digite a Nota Fiscal" style="display:none; margin-left:10px; width:200px;">
  </div>
  <div style="margin-bottom:10px;">
    <button onclick="startScan('produto')">Escanear Produto</button>
    <button onclick="showManualInput('produto')">Digitar Produto</button>
    <input type="text" id="manualProduto" placeholder="Digite o Produto" style="display:none; margin-left:10px; width:200px;">
  </div>
  <input type="number" id="quantidade" placeholder="Quantidade do lote">
  <button onclick="showResults()">Mostrar Resultados</button>
  <button onclick="sendWhatsApp()">Enviar via WhatsApp</button>
  <div id="result">Aguardando escaneamento...</div>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://docs.opencv.org/4.5.0/opencv.js"></script>
  <script>
    let notaFiscal = '';
    let produto = '';
    let quantidade = '';
    let manualMode = { nota: false, produto: false };
    let streamTrack = null;
    const flashBtn = document.getElementById('flashBtn');
    const cameraSelect = document.getElementById('cameraSelect');
    let selectedDeviceId = null;

    function showManualInput(tipo) {
      if (tipo === 'nota') {
        document.getElementById('manualNota').style.display = 'inline-block';
        manualMode.nota = true;
        stopVideo();
        focusRect.style.display = 'none';
      } else {
        document.getElementById('manualProduto').style.display = 'inline-block';
        manualMode.produto = true;
        stopVideo();
        focusRect.style.display = 'none';
      }
    }
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultDiv = document.getElementById('result');
    const focusRect = document.getElementById('focusRect');
    const codeReader = new ZXing.BrowserBarcodeReader({
      barcodeFormats: [
        ZXing.BarcodeFormat.CODE_128,
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.EAN_8,
        ZXing.BarcodeFormat.UPC_A,
        ZXing.BarcodeFormat.UPC_E
      ]
    });

    async function startScan(tipo) {
      if (tipo === 'nota') {
        document.getElementById('manualNota').style.display = 'none';
        manualMode.nota = false;
      } else {
        document.getElementById('manualProduto').style.display = 'none';
        manualMode.produto = false;
      }
      resultDiv.innerHTML = `Escaneando ${tipo === 'nota' ? 'Nota Fiscal' : 'Produto'}...`;
      focusRect.style.display = 'block';
      // Listar câmeras disponíveis
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === 'videoinput');
      cameraSelect.innerHTML = '';
      if (videoDevices.length > 1) {
        cameraSelect.style.display = 'inline-block';
        videoDevices.forEach((device, idx) => {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.text = device.label || `Câmera ${idx+1}`;
          cameraSelect.appendChild(option);
        });
        cameraSelect.onchange = function() {
          selectedDeviceId = cameraSelect.value;
          stopVideo();
          startScan(tipo);
        };
        selectedDeviceId = cameraSelect.value || videoDevices[0].deviceId;
      } else {
        cameraSelect.style.display = 'none';
        selectedDeviceId = videoDevices[0]?.deviceId || null;
      }
      try {
        // Iniciar stream de vídeo
        const constraints = { video: { deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined, facingMode: 'environment' } };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        video.play();
        // Verifica suporte ao flash
        streamTrack = stream.getVideoTracks()[0];
        if (streamTrack && streamTrack.getCapabilities) {
          const caps = streamTrack.getCapabilities();
          if (caps.torch) {
            flashBtn.style.display = 'inline-block';
          } else {
            flashBtn.style.display = 'none';
          }
        }
        // Aguarda vídeo carregar para pegar dimensões corretas
        await new Promise(resolve => {
          video.onloadedmetadata = resolve;
        });

        // Configurar canvas para pré-processamento
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Definir área de foco central
        const focusW = Math.floor(canvas.width * 0.8);
        const focusH = 150;
        const focusX = Math.floor((canvas.width - focusW) / 2);
        const focusY = Math.floor((canvas.height - focusH) / 2);

        // Loop para pré-processar e escanear
        async function scanFrame() {
          if (!video.srcObject) return; // Para o loop se o vídeo for parado
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          // Captura apenas a área de foco
          let frame = ctx.getImageData(focusX, focusY, focusW, focusH);
          let tempCanvas = document.createElement('canvas');
          tempCanvas.width = focusW;
          tempCanvas.height = focusH;
          let tempCtx = tempCanvas.getContext('2d');
          tempCtx.putImageData(frame, 0, 0);

          // OpenCV: pré-processamento
          let src = cv.imread(tempCanvas);
          let dst = new cv.Mat();
          cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY); // Escala de cinza
          // Aplica sharpening (nitidez)
          let kernel = cv.Mat.ones(3, 3, cv.CV_32F);
          kernel.data32F[4] = 9.0;
          kernel.data32F[1] = kernel.data32F[3] = kernel.data32F[5] = kernel.data32F[7] = -1.0;
          cv.filter2D(dst, dst, cv.CV_8U, kernel);
          cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 2);

          // Exibe área processada no canvas principal para debug
          cv.imshow(canvas, dst);
          src.delete();
          dst.delete();
          kernel.delete();

          try {
            const result = await codeReader.decodeFromImage(canvas);
            if (result) {
              if (tipo === 'nota') {
                notaFiscal = result.text;
                resultDiv.innerHTML = `Nota Fiscal escaneada: ${notaFiscal}`;
              } else {
                produto = result.text;
                resultDiv.innerHTML = `Produto escaneado: ${produto}`;
              }
              stopVideo();
              focusRect.style.display = 'none';
              alert(`${tipo === 'nota' ? 'Nota Fiscal' : 'Produto'} escaneado: ${result.text}`);
            } else {
              requestAnimationFrame(scanFrame); // Continua escaneando
            }
          } catch (err) {
            requestAnimationFrame(scanFrame); // Continua escaneando
          }
        }
        requestAnimationFrame(scanFrame);
      } catch (err) {
        resultDiv.innerHTML = 'Erro ao acessar a câmera. Verifique permissões.';
        console.error('Erro: ', err);
        focusRect.style.display = 'none';
      }
    }

    function stopVideo() {
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      flashBtn.style.display = 'none';
      cameraSelect.style.display = 'none';
    }

    function showResults() {
      // Se estiver em modo manual, pegar valores dos inputs
      if (manualMode.nota) {
        notaFiscal = document.getElementById('manualNota').value;
      }
      if (manualMode.produto) {
        produto = document.getElementById('manualProduto').value;
      }
      quantidade = document.getElementById('quantidade').value;
      if (notaFiscal && produto && quantidade) {
        resultDiv.innerHTML = `Nota Fiscal: ${notaFiscal}<br>Produto: ${produto}<br>Quantidade: ${quantidade}`;
      } else {
        resultDiv.innerHTML = 'Escaneie ou digite ambos os códigos e informe a quantidade!';
      }
    }

    function sendWhatsApp() {
      if (manualMode.nota) {
        notaFiscal = document.getElementById('manualNota').value;
      }
      if (manualMode.produto) {
        produto = document.getElementById('manualProduto').value;
      }
      quantidade = document.getElementById('quantidade').value;
      if (notaFiscal && produto && quantidade) {
        const message = `Nota Fiscal: ${notaFiscal}\nProduto: ${produto}\nQuantidade: ${quantidade}`;
        const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
      } else {
        alert('Preencha todas as informações antes de enviar!');
      }
    }

    // Controle do flash
    flashBtn.onclick = async function() {
      if (streamTrack && streamTrack.getCapabilities && streamTrack.getCapabilities().torch) {
        const settings = streamTrack.getSettings();
        const isOn = settings.torch === true;
        try {
          await streamTrack.applyConstraints({ advanced: [{ torch: !isOn }] });
          flashBtn.textContent = !isOn ? 'Desligar Flash' : 'Ligar Flash';
        } catch (e) {
          alert('Não foi possível controlar o flash nesta câmera.');
        }
      }
    };
  </script>
</body>
</html>