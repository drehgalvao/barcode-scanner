
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processador de NF e Itens via Câmera</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.0/dist/tesseract.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-top: 20px; }
        #result, #data { margin-top: 10px; }
        button { margin-right: 10px; }
        #video { width: 100%; max-width: 400px; display: none; }
        #canvas { display: none; }
    </style>
</head>
<body>
    <h2>Processador de Nota Fiscal e Itens</h2>
    <div id="step1" class="section">
        <h3>Passo 1: Tire uma foto da Nota Fiscal</h3>
        <video id="video1" autoplay playsinline></video>
        <button onclick="captureNF()">Tirar Foto</button>
        <button onclick="stopCamera('video1')">Parar Câmera</button>
        <div id="nfResult"></div>
    </div>
    <div id="step2" class="section" style="display: none;">
        <h3>Passo 2: Tire uma foto da Etiqueta de Produto</h3>
        <video id="video2" autoplay playsinline></video>
        <button onclick="captureItem()">Tirar Foto</button>
        <button onclick="stopCamera('video2')">Parar Câmera</button>
        <button onclick="processItem()">Adicionar Item</button>
        <button onclick="finalize()">Finalizar</button>
        <div id="itemResult"></div>
    </div>
    <div id="data"></div>
    <button onclick="sendWhatsApp()" id="sendBtn" style="display: none;">Enviar via WhatsApp</button>
    <canvas id="canvas" width="400" height="300"></canvas>

    <script>
        let nfData = {};
        let items = [];
        let stream1 = null;
        let stream2 = null;
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');

        async function startCamera(videoId) {
            const video = document.getElementById(videoId);
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.style.display = 'block';
                if (videoId === 'video1') stream1 = stream;
                else stream2 = stream;
            } catch (err) {
                alert('Erro ao acessar a câmera: ' + err.message);
            }
        }

        function stopCamera(videoId) {
            const video = document.getElementById(videoId);
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                video.style.display = 'none';
            }
        }

        async function captureNF() {
            const video = document.getElementById('video1');
            if (!stream1) startCamera('video1');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/png');
            stopCamera('video1');
            await processNFImage(imageData);
        }

        async function captureItem() {
            const video = document.getElementById('video2');
            if (!stream2) startCamera('video2');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/png');
            stopCamera('video2');
            await processItemImage(imageData);
        }

        async function processNFImage(imageData) {
            const resultDiv = document.getElementById('nfResult');
            resultDiv.innerHTML = 'Processando...';
            const { data: { text } } = await Tesseract.recognize(imageData, 'por');
            resultDiv.innerHTML = 'Texto extraído: <pre>' + text + '</pre>';

            // Extrair número da nota fiscal e nome do cliente
            const nfNumberMatch = text.match(/NF[-e]\s*:\s*(\d+)/i);
            const clientNameMatch = text.match(/RAZAO SOCIAL[:\s]*([A-Za-z\s]+)/i);
            nfData = {
                nfNumber: nfNumberMatch ? nfNumberMatch[1] : 'Não identificado',
                clientName: clientNameMatch ? clientNameMatch[1].trim() : 'Não identificado'
            };
            resultDiv.innerHTML += `<p>Número NF: ${nfData.nfNumber}<br>Nome Cliente: ${nfData.clientName}</p>`;
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            startCamera('video2');
        }

        async function processItemImage(imageData) {
            const resultDiv = document.getElementById('itemResult');
            resultDiv.innerHTML = 'Processando...';
            const { data: { text } } = await Tesseract.recognize(imageData, 'por');
            resultDiv.innerHTML = 'Texto extraído: <pre>' + text + '</pre>';

            // Extrair OP, data e código do produto
            const opMatch = text.match(/OP[:\s]*(\d+)/i); // Ex.: 472462
            const dateMatch = text.match(/(\d{2}\/\d{2}\/\d{4})/); // Ex.: 23/06/2025
            const productCodeMatch = text.match(/(\d{2}\.\d{2}\.\d{2}\.\d{4})/); // Ex.: 07.21.05.0011

            let itemData = {
                op: opMatch ? opMatch[1] : 'Não identificado',
                date: dateMatch ? dateMatch[1] : 'Não identificado',
                productCode: productCodeMatch ? productCodeMatch[1] : 'Não identificado',
                quantity: prompt('Digite a quantidade para esta OP:') || 0
            };
            items.push(itemData);
            resultDiv.innerHTML += `<p>OP: ${itemData.op}<br>Data: ${itemData.date}<br>Código: ${itemData.productCode}<br>Quantidade: ${itemData.quantity}</p>`;
        }

        function finalize() {
            stopCamera('video2');
            const dataDiv = document.getElementById('data');
            let finalData = `Nota Fiscal: ${nfData.nfNumber}\nCliente: ${nfData.clientName}\nItens:\n`;
            items.forEach((item, index) => {
                finalData += `Item ${index + 1}: OP ${item.op}, Data ${item.date}, Código ${item.productCode}, Quantidade ${item.quantity}\n`;
            });
            dataDiv.innerHTML = `<pre>${finalData}</pre>`;
            window.finalText = finalData;
            document.getElementById('sendBtn').style.display = 'block';
            document.getElementById('step2').style.display = 'none';
        }

        function sendWhatsApp() {
            const text = window.finalText || 'Nenhum dado para enviar.';
            window.location.href = `whatsapp://send?text=${encodeURIComponent(text)}`;
        }

        // Iniciar com a câmera da nota fiscal
        window.onload = () => startCamera('video1');
    </script>
</body>
</html>